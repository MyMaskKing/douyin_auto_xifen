# 抖音自动涨粉工具设计文档

## 项目概述

抖音自动涨粉工具是一个自动化工具，用于管理抖音账号的关注和粉丝关系，提高账号的粉丝数量和互动率。该工具可以自动检查关注列表，识别未回关的用户，并根据配置自动取关这些用户。

## 系统架构

系统由以下几个主要模块组成：

1. **浏览器管理模块 (core/browser.py)**：负责浏览器的启动、关闭、状态检查和会话管理。
2. **任务运行模块 (core/task_runner.py)**：负责调度和执行各种任务，如取关、关注粉丝等。
3. **关注列表管理模块 (core/follow_manager.py)**：负责处理关注列表相关操作，如检查关注列表、标记未回关用户等。
4. **数据库模块 (utils/db.py)**：负责数据的存储和检索，包括用户信息、关注记录等。
5. **配置模块 (utils/config.py)**：负责读取和验证配置信息。
6. **日志模块 (core/logger.py)**：负责记录系统运行日志。

## 功能说明

### 1. 检查关注列表

**功能**：检查当前账号的关注列表，找出未回关的用户，并标记为待取关。

**使用方法**：系统会自动执行该任务，无需手动操作。

**参数说明**：
- `unfollow_days`：配置文件中设置的取关天数阈值，超过该天数的未回关用户会被标记为待取关。当设置为0时，立即标记为待取关。

**返回值**：
- 成功返回True，失败返回False。

### 2. 取关任务

**功能**：取关已标记为待取关的用户。

**使用方法**：系统会自动执行该任务，无需手动操作。

**参数说明**：
- `max_unfollow_per_day`：配置文件中设置的每日最大取关数量。

**返回值**：
- 成功返回True，失败返回False。

### 3. 关注粉丝任务

**功能**：自动关注粉丝列表中的用户。

**使用方法**：系统会自动执行该任务，无需手动操作。

**参数说明**：
- `max_follow_per_day`：配置文件中设置的每日最大关注数量。

**返回值**：
- 成功返回True，失败返回False。

## 最近优化

### 2025-03-10 优化

1. **关注状态处理**：修改了关注状态处理逻辑，确保无法确定关注状态的用户不会被放入取关列表，只有明确标记为"已关注"的用户才会被标记为待取关。

2. **立即取关功能**：增强了数据库中的`mark_user_for_unfollow`方法，支持`unfollow_days`为0时立即执行取关操作，不考虑关注时间。

3. **关闭弹窗优化**：优化了关闭弹窗的代码，直接使用JavaScript精确定位并点击关闭按钮，移除了无效的直接点击方法，提高了关闭弹窗的成功率。

4. **代码拆分**：将`task_runner.py`文件中的`run_check_follows_task`方法移到新的`follow_manager.py`文件中，创建了`FollowListManager`类，减少了单个文件的代码量，提高了代码的可维护性。

5. **修复导入错误**：修复了`task_runner.py`中导入`FollowListManager`但在`follow_manager.py`中定义为`FollowManager`的不一致问题，确保了类名的一致性。

6. **完成代码拆分**：完成了代码拆分工作，从`task_runner.py`中移除了`run_check_follows_task`方法，并正确初始化了`FollowListManager`实例，确保代码能够正常运行。

7. **修复douyin_bot.py中的导入错误**：修复了`douyin_bot.py`中导入`FollowManager`的错误，改为导入`FollowListManager`，并正确传递`config`参数，确保整个系统能够正常运行。

8. **修复运行异常**：
   - 修复了`task_runner.py`中方法调用不一致的问题，将`get_unfollow_count_today`改为`get_today_unfollow_count`
   - 优化了`follow_manager.py`中关注按钮的选择器，增加了更多可能的选择器
   - 改进了点击关注按钮的代码，添加了更详细的日志和更好的错误处理
   - 添加了使用JavaScript点击关注按钮的备用方案，提高了打开关注列表弹窗的成功率

9. **根据备份文件修复关注用户检查功能**：
   - 修改了访问个人主页的URL，从`/user`改为`/user/self`
   - 优化了关注按钮的查找方式，先尝试直接使用data-e2e属性查找，再使用备用选择器
   - 改进了弹窗查找逻辑，使用更精确的选择器并保存弹窗元素
   - 优化了用户项选择器，使用更多的备用选择器提高查找成功率
   - 增强了标签页标题中关注总数的提取逻辑
   - 整体提高了关注用户检查功能的稳定性和成功率

## 待优化项

1. **错误处理**：进一步完善错误处理机制，提高系统的稳定性。
2. **性能优化**：优化滚动加载和用户处理逻辑，提高处理效率。
3. **用户界面**：考虑添加简单的用户界面，方便用户查看任务执行情况和统计数据。
4. **多账号支持**：考虑添加多账号支持，允许同时管理多个抖音账号。 