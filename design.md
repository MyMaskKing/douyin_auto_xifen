# 抖音Web版自动涨粉工具设计方案

## 1. 项目概述

这是一个基于Edge浏览器中抖音Web应用的自动化涨粉工具，通过模拟真实用户操作来增加粉丝数量。工具设计简单易用，专注于核心功能。

## 2. 技术架构

### 2.1 核心技术栈
- Python 3.9+
- Selenium WebDriver
- Edge WebDriver
- SQLite（简单数据记录）

### 2.2 主要功能
- 自动关注目标用户的粉丝
- 自动点赞和评论
- 定时取关未回关用户
- 简单的数据统计
- 目标用户处理状态跟踪
- 全天运行模式支持
- 功能模块独立控制

## 3. 操作流程

### 3.1 基础设置
1. 配置Edge浏览器和抖音Web应用
2. 设置每日关注上限（建议100-200）
3. 设置操作时间间隔（避免过快）
4. 预设常用评论话术
5. 配置工作时间或启用全天运行模式
6. 配置功能模块开关

### 3.2 自动化流程
1. **关注操作**：
   - 通过Web接口访问目标用户主页
   - 进入粉丝列表页面
   - 自动关注粉丝
   - 记录关注的用户

2. **互动操作**：
   - 对视频进行点赞
   - 发送预设评论
   - 模拟正常浏览行为

3. **数据记录**：
   - 记录每日关注数量
   - 记录互动次数
   - 标记已关注用户
   - 记录目标用户处理状态

4. **取关操作**：
   - 获取需要取关的用户列表
   - 访问用户主页
   - 执行取关操作
   - 更新数据库记录

5. **审查关注列表**：
   - 检查已关注用户的活跃度
   - 分析互动情况
   - 标记潜在的优质用户

### 3.3 安全控制
- 每日操作次数限制
- 随机等待时间
- 模拟真实浏览行为
- 操作间加入随机停顿

### 3.4 DOM结构适配
- 支持新版抖音Web界面的DOM结构
- 使用data-e2e属性识别关注按钮
- 动态识别用户信息元素
- 多种选择器策略确保兼容性

### 3.5 用户去重机制
- 使用集合记录已处理用户
- 基于用户名进行去重
- 避免循环处理同一用户
- 跳过已处理的用户项

### 3.6 目标用户处理状态跟踪
- 记录已处理的目标用户
- 避免重复处理同一目标用户
- 统计每个目标用户的处理次数
- 优先处理未处理过的目标用户

### 3.7 全天运行模式
- 可配置工作时间范围或全天运行
- 全天模式下不受时间限制
- 工作时间模式下只在指定时间段运行
- 灵活适应不同使用场景

### 3.8 功能模块独立控制
- 关注粉丝功能可独立开关
- 审查关注列表功能可独立开关
- 取关用户功能可独立开关
- 通过配置文件灵活控制功能组合

## 4. 使用建议

### 4.1 日常使用
- 确保Edge浏览器已安装抖音Web应用
- 保持浏览器登录状态
- 定期检查账号状态
- 适当调整操作频率

### 4.2 注意事项
- 使用固定IP地址
- 保持正常的浏览行为
- 评论内容要有关联性
- 定期清理未回关用户

## 5. 数据记录

### 5.1 基础数据
- 关注用户记录
- 互动历史记录
- 操作日志
- 目标用户处理记录

### 5.2 统计数据
- 每日新增粉丝
- 互动转化率
- 取关记录
- 目标用户处理统计

## 6. 风险控制

### 6.1 操作频率
- 每日关注：100-200人
- 点赞频率：每5-10分钟一次
- 评论频率：每10-15分钟一次
- 取关频率：每天不超过100人

### 6.2 账号保护
- 避免深夜操作（除非启用全天模式）
- 保持正常浏览节奏
- 适当的互动频率
- 合理的关注比例

## 7. 错误处理与恢复

### 7.1 错误处理策略
- 详细的日志记录
- 截图保存错误现场
- HTML源码保存分析
- 智能重试机制

### 7.2 恢复机制
- 跳过问题用户继续执行
- 目标用户级别的错误隔离
- 自动重新加载页面
- 会话状态保持

## 8. 代码重构建议

为了提高代码的可维护性和可读性，建议将超过1000行的`core/douyin_bot.py`文件拆分为以下模块：

### 8.1 模块划分

1. **core/logger.py**
   - 日志系统相关功能
   - 截图和HTML保存功能
   - 日志路径管理

2. **core/browser.py**
   - 浏览器初始化和配置
   - 浏览器会话管理
   - 登录状态验证

3. **core/user_profile.py**
   - 用户资料访问功能
   - 用户主页解析
   - 用户信息提取

4. **core/fan_manager.py**
   - 粉丝列表获取和处理
   - 粉丝项解析
   - 粉丝数据提取

5. **core/follow_manager.py**
   - 关注用户功能
   - 取消关注功能
   - 关注状态检查

6. **core/task_runner.py**
   - 任务调度和执行
   - 工作时间管理
   - 任务状态跟踪

7. **core/douyin_bot.py**
   - 主类定义（精简版）
   - 组合其他模块功能
   - 对外接口

### 8.2 重构优势

1. **提高可维护性**：每个模块专注于特定功能，更容易理解和维护
2. **便于协作开发**：不同开发者可以同时处理不同模块
3. **提高代码复用**：功能模块化后更容易在其他项目中复用
4. **简化测试**：可以为每个模块编写单独的测试
5. **降低修改风险**：修改一个模块不会影响其他模块

### 8.3 实施步骤

1. 创建新的模块文件
2. 将相关功能从`douyin_bot.py`移动到对应模块
3. 在`douyin_bot.py`中导入并使用这些模块
4. 确保所有功能正常工作
5. 更新文档和注释

### 8.4 注意事项

- 保持模块之间的接口清晰
- 避免循环依赖
- 确保异常处理在模块间正确传递
- 维护一致的日志记录风格

## 9. 最新功能说明

### 9.1 目标用户处理状态跟踪

#### 9.1.1 功能说明
- 通过数据库记录已处理的目标用户信息
- 避免在同一天内重复处理相同的目标用户
- 统计每个目标用户的处理次数和最后处理时间

#### 9.1.2 相关方法
- `is_target_user_processed(user_id)`: 检查目标用户是否已在今天被处理过
- `mark_target_user_processed(user_id)`: 标记目标用户为已处理，记录处理时间和次数

#### 9.1.3 使用场景
- 在处理目标用户前，先检查是否已处理过
- 处理完目标用户后，标记为已处理
- 优先处理未处理过的目标用户

### 9.2 全天运行模式

#### 9.2.1 功能说明
- 支持在配置中设置`all_day_operation`参数
- 当设置为`True`时，不受工作时间限制，全天运行
- 当设置为`False`时，仅在配置的工作时间范围内运行

#### 9.2.2 配置示例
```python
{
    "all_day_operation": True,  # 启用全天运行模式
    "working_hours": {
        "start": 9,  # 工作开始时间（小时）
        "end": 22    # 工作结束时间（小时）
    }
}
```

#### 9.2.3 使用场景
- 需要24小时不间断运行的场景
- 特定时间段运行的场景
- 根据账号安全需求灵活配置运行时间

### 9.3 取关功能优化

#### 9.3.1 功能说明
- 优化取关流程，先访问用户主页再执行取关操作
- 增强错误处理和日志记录
- 添加截图功能记录取关过程

#### 9.3.2 相关方法
- `unfollow_user(username, user_id)`: 取消关注指定用户
- `get_users_to_unfollow(days, limit)`: 获取需要取关的用户列表

#### 9.3.3 使用场景
- 定期清理未回关用户
- 控制关注比例
- 维护账号健康度

### 9.4 功能模块独立控制

#### 9.4.1 功能说明
- 将主要功能分为三个独立模块：关注粉丝、审查关注列表、取关用户
- 每个功能模块可以通过配置文件独立开关
- 支持灵活组合不同功能模块

#### 9.4.2 配置示例
```python
{
    "features": {
        "follow_fans": True,      # 是否启用关注粉丝功能
        "check_follows": True,    # 是否启用审查关注列表功能
        "unfollow_users": True    # 是否启用取关功能
    }
}
```

#### 9.4.3 相关方法
- `run_follow_fans_task()`: 执行关注粉丝任务
- `run_check_follows_task()`: 执行审查关注列表任务
- `run_unfollow_task()`: 执行取关任务

#### 9.4.4 使用场景
- 只需要关注粉丝功能时，可以关闭其他功能
- 只需要取关功能时，可以关闭其他功能
- 根据不同时间段需求灵活配置功能组合

### 9.5 审查关注列表功能

#### 9.5.1 功能说明
- 自动访问个人主页的关注列表
- 识别互相关注和未回关的用户
- 统计关注情况（总关注数、互相关注数、未回关数）
- 将未回关且超过指定天数的用户标记为待取关

#### 9.5.2 实现流程
1. 访问个人主页
2. 点击关注标签，进入关注列表页面
3. 滚动加载更多关注用户（默认最多滚动5次）
4. 提取每个关注用户的信息（用户名、用户ID、是否互相关注）
5. 统计关注情况
6. 找出未回关的用户
7. 将未回关且超过指定天数的用户标记为待取关

#### 9.5.3 相关方法
- `run_check_follows_task()`: 执行审查关注列表任务
- `mark_user_for_unfollow(user_id, username, days)`: 标记用户为待取关

#### 9.5.4 数据库表结构
follows表新增字段：
- `should_unfollow`: 是否应该取关（0-否，1-是）
- `marked_for_unfollow_time`: 标记为待取关的时间

#### 9.5.5 使用场景
- 定期检查关注列表，找出未回关的用户
- 自动标记长期未回关的用户为待取关
- 与取关功能配合使用，实现自动清理未回关用户 