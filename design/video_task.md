# 视频相关任务设计文档

## 1. 概述

本文档详细描述抖音自动化工具中与视频处理相关的任务设计，包括视频评论、用户信息提取、视频处理状态管理等功能。

## 2. 数据库设计

### 2.1 视频处理记录表 (processed_videos)

| 字段名 | 类型 | 说明 |
|-------|------|------|
| video_url | TEXT | 视频链接，主键 |
| processed_time | TIMESTAMP | 处理时间 |
| success | INTEGER | 处理是否成功，1表示成功，0表示失败 |

### 2.2 评论记录表 (comments)

| 字段名 | 类型 | 说明 |
|-------|------|------|
| id | INTEGER | 自增主键 |
| video_id | TEXT | 视频ID |
| comment_text | TEXT | 评论内容 |
| comment_time | TIMESTAMP | 评论时间 |

### 2.3 目标视频表 (target_videos)

| 字段名 | 类型 | 说明 |
|-------|------|------|
| video_id | TEXT | 视频ID，主键 |
| processed_time | TIMESTAMP | 处理时间 |
| follow_count | INTEGER | 关注的用户数量 |
| comment_count | INTEGER | 评论的数量 |

## 3. 视频评论与用户提取功能

### 3.1 功能描述

该功能负责自动访问抖音视频页面，发表评论，并提取视频下的用户信息（评论者、点赞者等）。

### 3.2 处理流程

```
开始
  |
  v
检查视频是否已处理 --> 已处理 --> 跳过处理
  |
  v (未处理)
打开视频页面
  |
  v
等待页面加载完成
  |
  v
发表评论
  |
  v
提取用户信息
  |
  v
将用户添加到待关注列表
  |
  v
标记视频为已处理
  |
  v
结束
```

### 3.3 详细步骤

#### 3.3.1 检查视频是否已处理

1. 调用数据库模块中的视频处理状态检查方法，查询视频URL是否存在于processed_videos表中
2. 该方法使用SQLite数据库操作，通过SQL查询语句检索视频URL的记录数量
3. 如果查询结果大于0，表示视频已处理，返回True；否则返回False
4. 异常处理机制会捕获并记录数据库操作过程中可能出现的错误

#### 3.3.2 打开视频页面

1. 使用Selenium WebDriver的get方法打开视频链接
2. 通过WebDriverWait和ExpectedConditions等待视频元素加载完成
3. 使用自定义的随机等待函数，模拟人类操作的随机性，等待3-5秒
4. 异常处理机制会捕获并记录页面加载过程中可能出现的错误

#### 3.3.3 发表评论

1. 使用WebDriverWait和XPath定位评论输入框元素
2. 从配置文件中的评论模板列表随机选择一条评论内容
3. 使用Selenium的click和send_keys方法点击输入框并输入评论内容
4. 定位并点击发送按钮，使用随机等待模拟人类操作
5. 通过页面元素变化验证评论是否发送成功
6. 如果评论成功，调用数据库模块记录评论信息
7. 异常处理机制会捕获并记录评论过程中可能出现的错误

#### 3.3.4 提取用户信息

1. 使用WebDriverWait和XPath定位评论区域元素
2. 通过JavaScript滚动操作加载更多评论
3. 使用XPath批量获取评论项元素列表
4. 遍历评论项，提取每个评论者的用户ID和用户名
   - 通过XPath定位用户链接元素
   - 从链接href属性中提取用户ID
   - 从元素文本中获取用户名
5. 对于每个有效的用户信息，调用数据库模块的add_follow_fan方法添加到待关注列表
6. 记录成功提取的用户数量
7. 异常处理机制会捕获并记录用户提取过程中可能出现的错误

#### 3.3.5 标记视频为已处理

1. 调用数据库模块的视频处理状态标记方法
2. 该方法使用SQLite数据库操作，通过INSERT OR REPLACE语句更新processed_videos表
3. 记录视频URL、处理时间和处理结果（成功/失败）
4. 使用数据库事务确保操作的原子性
5. 异常处理机制会捕获并记录数据库操作过程中可能出现的错误

### 3.4 主要方法

#### 3.4.1 comment_and_extract_users

该方法是视频评论与用户提取功能的主入口，整合了上述所有步骤：

1. 首先调用数据库模块检查视频是否已处理
2. 如果未处理，使用WebDriver打开视频页面
3. 从视频URL中提取视频ID
4. 调用评论发布方法发表评论
5. 调用用户提取方法提取用户信息
6. 根据评论和用户提取的结果，调用数据库模块标记视频处理状态
7. 返回操作是否成功的布尔值
8. 异常处理机制会捕获并记录整个过程中可能出现的错误

#### 3.4.2 process_target_videos

该方法用于批量处理目标视频列表：

1. 初始化处理结果统计字典，包括总数、已处理数、跳过数和失败数
2. 调用数据库模块获取未处理的目标视频列表
3. 遍历未处理视频列表，对每个视频调用comment_and_extract_users方法
4. 根据处理结果更新统计数据
5. 在视频处理之间使用随机等待，避免操作过于频繁
6. 返回处理结果统计
7. 异常处理机制会捕获并记录批量处理过程中可能出现的错误

## 4. 视频处理状态管理

### 4.1 功能描述

该功能负责管理视频的处理状态，包括标记视频为已处理、获取未处理的视频等。

### 4.2 处理流程

```
开始
  |
  v
检查视频是否在processed_videos表中 --> 存在 --> 返回已处理状态
  |
  v (不存在)
将视频信息插入processed_videos表
  |
  v
设置处理时间和处理结果
  |
  v
提交数据库事务
  |
  v
结束
```

### 4.3 主要方法

#### 4.3.1 is_video_processed

该方法用于检查视频是否已经处理过：

1. 接收视频URL作为参数，返回布尔值表示是否已处理
2. 使用SQLite数据库连接对象获取游标
3. 执行SQL查询语句，计算processed_videos表中匹配视频URL的记录数量
4. 如果记录数大于0，表示视频已处理，返回True；否则返回False
5. 使用try-except结构捕获可能的数据库异常
6. 异常发生时，使用logger记录错误信息并返回False
7. 该方法主要用于避免重复处理同一视频，提高效率

#### 4.3.2 mark_video_processed

该方法用于标记视频为已处理：

1. 接收视频URL和处理结果（成功/失败）作为参数
2. 使用SQLite数据库连接对象获取游标
3. 执行INSERT OR REPLACE SQL语句，更新processed_videos表
4. 记录视频URL、当前时间戳和处理结果（1表示成功，0表示失败）
5. 提交数据库事务，确保数据持久化
6. 使用logger记录操作成功信息
7. 使用try-except结构捕获可能的数据库异常
8. 异常发生时，使用logger记录错误信息
9. 该方法确保视频处理状态被正确记录，便于后续查询和统计

#### 4.3.3 get_unprocessed_target_videos

该方法用于获取未处理的目标视频：

1. 接收目标视频列表和时间范围（天数）作为参数
2. 如果目标视频列表为空，直接返回空列表
3. 计算起始日期（当前日期减去指定天数）
4. 检查target_videos表是否存在
   - 如果不存在，创建该表并设置适当的字段和约束
   - 表创建后返回所有目标视频，因为都未处理
5. 如果表存在，构建SQL参数占位符，用于IN子句
6. 执行SQL查询，获取在指定时间范围内已处理的视频ID
7. 通过列表推导式筛选出未处理的视频
8. 返回未处理的视频ID列表
9. 使用try-except结构捕获可能的数据库异常
10. 异常发生时，使用logger记录错误信息并返回空列表
11. 该方法帮助系统高效地识别需要处理的视频，避免重复工作

## 5. 评论管理功能

### 5.1 功能描述

该功能负责管理视频评论，包括添加评论记录、清空评论记录等。

### 5.2 处理流程

```
开始
  |
  v
检查comments表是否存在 --> 不存在 --> 创建comments表
  |
  v (存在)
添加评论记录
  |
  v
提交数据库事务
  |
  v
结束
```

### 5.3 主要方法

#### 5.3.1 add_comment_record

该方法用于添加评论记录：

1. 接收视频ID和评论内容作为参数，返回布尔值表示操作是否成功
2. 获取当前时间戳，用于记录评论时间
3. 使用SQLite数据库连接对象获取游标
4. 检查comments表是否存在
   - 使用SQLite系统表sqlite_master查询表是否存在
   - 如果不存在，创建comments表，设置id为自增主键，包含video_id、comment_text和comment_time字段
   - 提交数据库事务并记录日志
5. 执行INSERT SQL语句，将评论记录插入comments表
   - 包含视频ID、评论内容和当前时间
6. 提交数据库事务，确保数据持久化
7. 使用logger记录操作成功信息，包含视频ID和评论内容
8. 返回True表示操作成功
9. 使用try-except结构捕获可能的数据库异常
10. 异常发生时，使用logger记录错误信息并返回False
11. 该方法确保系统能够追踪每个视频的评论历史，便于后续分析和管理

#### 5.3.2 clear_video_comments

该方法用于清空评论记录：

1. 接收可选参数days，表示要清除几天前的评论，如果为None则清除所有评论
2. 使用SQLite数据库连接对象获取游标
3. 检查comments表是否存在
   - 使用SQLite系统表sqlite_master查询表是否存在
   - 如果不存在，记录日志并返回True（无需清空）
4. 根据days参数执行不同的清空操作：
   - 如果days为None，执行DELETE语句清空整个表
   - 如果days有值，计算截止日期（当前日期减去指定天数）
   - 执行带WHERE子句的DELETE语句，只删除截止日期之前的评论
5. 提交数据库事务，确保操作生效
6. 使用logger记录操作成功信息
7. 返回True表示操作成功
8. 使用try-except结构捕获可能的数据库异常
9. 异常发生时，使用logger记录错误信息并返回False
10. 该方法帮助系统定期清理历史评论数据，避免数据库过大影响性能

## 6. 配置参数

### 6.1 视频评论配置

```yaml
video_comment:
  enabled: true                  # 是否启用视频评论功能
  max_videos_per_day: 20         # 每天最多处理的视频数量
  max_users_per_video: 20        # 每个视频最多提取的用户数量
  comments:                      # 评论模板列表
    - "不错的视频，支持一下！"
    - "学到了很多，感谢分享！"
    - "这个内容太棒了，继续加油！"
  wait_time:                     # 等待时间配置
    between_videos: [30, 60]     # 处理视频之间的等待时间范围（秒）
    after_comment: [3, 5]        # 发表评论后的等待时间范围（秒）
```

### 6.2 视频处理配置

```yaml
video_processing:
  days_to_keep: 7                # 保留处理记录的天数
  retry_failed: true             # 是否重试失败的视频
  max_retries: 3                 # 最大重试次数
```

## 7. 异常处理

### 7.1 常见异常

1. 网络连接异常
2. 页面元素未找到
3. 评论发送失败
4. 数据库操作异常

### 7.2 异常处理策略

1. 记录详细的错误日志
2. 对于网络异常，进行重试
3. 对于页面元素未找到，尝试不同的选择器
4. 对于评论发送失败，标记视频处理状态为失败
5. 对于数据库异常，回滚事务并记录错误

## 8. 日志记录

### 8.1 日志级别

1. INFO: 记录正常操作流程
2. WARNING: 记录可能的问题但不影响主要功能
3. ERROR: 记录导致功能失败的错误
4. DEBUG: 记录详细的调试信息

### 8.2 日志内容

1. 操作时间
2. 操作类型
3. 操作结果
4. 错误信息（如果有）
5. 相关数据（视频ID、用户ID等）

## 9. 性能优化

### 9.1 优化策略

1. 批量处理视频，减少浏览器启动次数
2. 使用数据库索引加速查询
3. 使用连接池管理数据库连接
4. 异步处理非关键操作
5. 定期清理历史数据，减少数据库大小 